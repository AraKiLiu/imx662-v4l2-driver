// SPDX-License-Identifier: GPL-2.0-only
// Device Tree Overlay for IMX662 camera module on Raspberry Pi CM5 (BCM2712)

/dts-v1/;
/plugin/;

/ {
	/*
	 * 將 compatible 加入 "brcm,bcm2712" 以表示相容 Raspberry Pi 5/CM5
	 * 也可保留 "brcm,bcm2835" 來涵蓋舊版韌體的廣義支援
	 */
	compatible = "brcm,bcm2712", "brcm,bcm2835";

	fragment@0 {
		target = <&cam_endpoint>;
		__overlay__ {
			data-lanes = <1 2>;
			link-frequencies = /bits/ 64 <594000000>;
		};
	};

	fragment@1 {
		target = <&cam_endpoint>;
		__dormant__ {
			data-lanes = <1 2 3 4>;
			link-frequencies = /bits/ 64 <297000000>;
		};
	};

	fragment@2 {
		target = <&csi_ep>;
		__overlay__ {
			data-lanes = <1 2>;
		};
	};

	fragment@3 {
		target = <&csi_ep>;
		__dormant__ {
			data-lanes = <1 2 3 4>;
		};
	};

	/*
	 * 將 i2c_csi_dsi 改為 i2c_csi_dsi0（假設使用CAM0 I2C）
	 * 確保在 config.txt 中已開啟: dtparam=i2c_csi_dsi0=on
	 */
	i2c_frag: fragment@10 {
		target = <&i2c_csi_dsi0>;
		__overlay__ {
			#address-cells = <1>;
			#size-cells = <0>;
			status = "okay";

			cam_node: imx662@1a {
				compatible = "sony,imx662";
				reg = <0x1a>;

				/*
				 * 若模組需要 SoC 輸出時脈，使用下列 clocks 屬性
				 * 對應前面 clk_frag 中的 cam0_clk
				 */
				clocks = <&cam0_clk>;
				clock-names = "xclk";
				/*
				 * 預設維持 37.125 MHz，視實際模組需求可改為 74.25 MHz
				 * 或其他已確定的頻率
				 */
				clock-frequency = <37125000>;

				rotation = <0>;
				orientation = <2>;

				/*
				 * 根據硬體對應的 regulator 進行修正
				 * 若使用 camera0 的 2.8V 腳位，可改為 &cam0_reg
				 */
				vdda-supply = <&cam0_reg>;           /* 2.8v */
				vdddo-supply = <&cam_dummy_reg>;     /* 1.8v */
				vddd-supply = <&cam_dummy_reg>;      /* 1.5v */

				port {
					cam_endpoint: endpoint {
						remote-endpoint = <&csi_ep>;
						clock-lanes = <0>;
					};
				};
			};
		};
	};

	/*
	 * 原本 target = <&csi1>; 改為 <&csi0> 代表使用CAM0
	 */
	csi_frag: fragment@11 {
		target = <&csi0>;
		csi: __overlay__ {
			status = "okay";
			brcm,media-controller;

			port {
				csi_ep: endpoint {
					remote-endpoint = <&cam_endpoint>;
				};
			};
		};
	};

	fragment@12 {
		target = <&i2c0if>;
		__overlay__ {
			status = "okay";
		};
	};

	/*
	 * 相機時脈：若由 SoC 提供 37.125 MHz 時脈，則綁定到 cam0_clk
	 * 可依實際情況改為 &cam1_clk 或自訂 fixed-clock
	 */
	clk_frag: fragment@13 {
		target = <&cam0_clk>;
		cam_clk: __overlay__ {
			status = "okay";
			clock-frequency = <37125000>;
		};
	};

	fragment@14 {
		target = <&i2c0mux>;
		__overlay__ {
			status = "okay";
		};
	};

	__overrides__ {
		/* 如果需要 4lane，可透過參數 4lane=1 來切換 Overlay */
		4lane = <0>, "-0+1-2+3";

		clock-frequency = <&cam_clk>,"clock-frequency:0",
				  <&cam_node>,"clock-frequency:0";

		rotation = <&cam_node>,"rotation:0";
		orientation = <&cam_node>,"orientation:0";
		media-controller = <&csi>,"brcm,media-controller?";

		/*
		 * 讓使用者在 config.txt 加參數 cam0=1 時
		 * 可以自動切換到CAM0介面 / 調整必要的節點
		 * 依據實際需要保留或移除下列這些 override
		 */
		cam0 = <&i2c_frag>, "target:0=", <&i2c_csi_dsi0>,
			<&csi_frag>, "target:0=", <&csi0>,
			<&clk_frag>, "target:0=", <&cam0_clk>,
			<&cam_node>, "clocks:0=", <&cam0_clk>,
			<&cam_node>, "vdda-supply:0=", <&cam0_reg>;

		mono = <0>, "";
	};
};
